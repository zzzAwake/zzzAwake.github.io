<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">

    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="apple-touch-icon" href="img/Touch-Icon.jpg">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <title>EPhone</title>
    <script src="https://unpkg.com/dexie/dist/dexie.js" defer></script>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div id="phone-frame">
        <div class="notch"></div>
        <div id="phone-screen">
            <div id="status-bar">
                <span id="status-bar-time">12:00</span>
                <div id="status-bar-battery" class="battery-container">
                    <span class="battery-text">--%</span>
                    <div class="battery-icon">
                        <div class="battery-level"></div>
                    </div>
                </div>
            </div>
            <div id="notification-bar"><img id="notification-avatar" src="">
                <div id="notification-content">
                    <div class="name"></div>
                    <div class="message"></div>
                </div>
            </div>

            <div id="home-screen" class="screen active">
                <div id="clock-container">
                    <div id="main-time">12:00</div>
                    <div id="main-date">星期一, 1月1日</div>
                </div>
                <!-- ▼▼▼ 全新优化的 id="app-grid" 结构 ▼▼▼ -->
                <div id="app-grid">
                    <div class="app-row">
                        <!-- 移除了 onclick, 新增 data-screen 属性 -->
                        <div class="app-icon" data-screen="world-book-screen">
                            <div class="icon-bg">
                                <img id="icon-img-world-book" src="img/World-Book.jpg" alt="世界书">
                            </div>
                            <span class="label">世界书</span>
                        </div>
                        <div class="app-icon" data-screen="chat-list-screen">
                            <div class="icon-bg">
                                <img id="icon-img-qq" src="img/QQ.jpg" alt="QQ">
                            </div>
                            <span class="label">QQ</span>
                        </div>
                    </div>
                    <div class="app-row">
                        <div class="app-icon" data-screen="api-settings-screen">
                            <div class="icon-bg">
                                <img id="icon-img-api-settings" src="img/API.jpg" alt="API设置">
                            </div>
                            <span class="label">API设置</span>
                        </div>
                        <div class="app-icon" data-screen="wallpaper-screen">
                            <div class="icon-bg">
                                <img id="icon-img-wallpaper" src="img/Wallpaper.jpg" alt="外观设置">
                            </div>
                            <span class="label">外观设置</span>
                        </div>
                        <div class="app-icon" data-screen="font-settings-screen">
                            <div class="icon-bg">
                                <img id="icon-img-font" src="img/Font.jpg" alt="字体">
                            </div>
                            <span class="label">字体</span>
                        </div>
                    </div>
                </div>
                <!-- ▲▲▲ 优化结束 ▲▲▲ -->
                <!-- ▲▲▲ 替换结束 ▲▲▲ -->
            </div>

            <div id="world-book-screen" class="screen">
                <div class="header">
                    <span class="back-btn" onclick="showScreen('home-screen')">‹</span>
                    <span>世界书</span>
                    <div class="header-actions"> <!-- 【推荐】用一个容器把按钮包起来 -->
                        <span class="action-btn" id="manage-world-book-categories-btn">管理分类</span>
                        <span class="action-btn" id="add-world-book-btn">+</span>
                    </div>
                </div>
                <div id="world-book-list"></div>
            </div>
            <div id="world-book-editor-screen" class="screen">
                <div class="header">
                    <span class="back-btn" onclick="showScreen('world-book-screen')">‹</span>
                    <span id="world-book-editor-title">编辑世界书</span>
                    <span class="save-btn" id="save-world-book-btn">保存</span>
                </div>
                <div class="form-container">
                    <div class="form-group">
                        <label for="world-book-name-input">书名</label>
                        <input type="text" id="world-book-name-input" placeholder="请输入世界书的名称...">
                    </div>

                    <!-- ▼▼▼ 【全新】在这里添加分类选择 ▼▼▼ -->
                    <div class="form-group">
                        <label for="world-book-category-select">分类</label>
                        <select id="world-book-category-select">
                            <!-- 选项将由JS动态生成 -->
                        </select>
                    </div>
                    <!-- ▲▲▲ 添加结束 ▲▲▲ -->

                    <div class="form-group" style="height: 100%;">
                        <label for="world-book-content-input">内容</label>
                        <textarea id="world-book-content-input" placeholder="在此处输入详细的世界观设定..."></textarea>
                    </div>
                </div>
            </div>

            <div id="api-settings-screen" class="screen">
                <div class="header"><span class="back-btn" onclick="showScreen('home-screen')">‹</span><span>API 设置</span><span style="width: 30px;"></span></div>
                <div class="form-container">
                    <p style="font-size: 14px; color: #666; background-color: #f0f0f0; padding: 10px; border-radius: 8px;">提示: 若要使用“发送图片”功能, 请务必选择支持Vision(视觉)的模型, 如<code style="background-color: #e0e0e0; padding: 2px 4px; border-radius: 4px;">gpt-4o</code>或<code style="background-color: #e0e0e0; padding: 2px 4px; border-radius: 4px;">gpt-4-vision-preview</code>。</p>
                    <div class="form-group"><label for="proxy-url">反代地址 (不需要添加/v1噢~)</label><input type="text" id="proxy-url" placeholder="例如: https://api.openai.com"></div>
                    <div class="form-group"><label for="api-key">密钥 (直连轮询用英文逗号隔开)</label><input type="password" id="api-key" placeholder="sk-..."></div>
                    <div class="form-group"><label for="model-select">模型</label><select id="model-select"></select></div><button class="form-button" id="fetch-models-btn">拉取模型</button>

                    <!-- ▼▼▼ 将这段代码粘贴到 API 设置页面的“保存设置”按钮上方 ▼▼▼ -->
                    <hr style="margin:20px 0; opacity:.3">
                    <div class="form-group" style="display: flex; justify-content: space-between; align-items: center;">
                        <label for="background-activity-switch" style="margin-bottom: 0;">
                            启用后台角色活动
                            <p style="font-size: 12px; font-weight: normal; color: #ff6b6b; margin-top: 5px;">
                                警告：此功能会显著增加API调用和费用！
                            </p>
                        </label>
                        <input type="checkbox" id="background-activity-switch" style="width: auto; height: 20px;">
                    </div>
                    <!-- ▲▲▲ 粘贴结束 ▲▲▲ -->

                    <!-- ▼▼▼ 将这段代码粘贴到“启用后台角色活动”开关的下方 ▼▼▼ -->
                    <div class="form-group" style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px;">
                        <label for="background-interval-input" style="margin-bottom: 0;">
                            后台活动检测间隔 (秒)
                            <p style="font-size: 12px; font-weight: normal; color: #999; margin-top: 5px;">
                                建议值 60-300。值越大，费用越低，但角色反应越慢。
                            </p>
                        </label>
                        <input type="number" id="background-interval-input" min="30" value="60" style="width: 80px; text-align: center;">
                    </div>
                    <!-- ▲▲▲ 粘贴结束 ▲▲▲ -->

                    <!-- ▼▼▼ 在这里新增 ▼▼▼ -->
                    <div class="form-group" style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px;">
                        <label for="block-cooldown-input" style="margin-bottom: 0;">
                            AI被拉黑后冷静期 (小时)
                            <p style="font-size: 12px; font-weight: normal; color: #999; margin-top: 5px;">
                                被拉黑超过这个时间后，AI才有几率重新申请好友。
                            </p>
                        </label>
                        <input type="number" id="block-cooldown-input" min="0.1" step="0.1" value="1" style="width: 80px; text-align: center;">
                    </div>
                    <!-- ▲▲▲ 新增结束 ▲▲▲ -->

                    <!-- ▼▼▼ 在这里新增 ▼▼▼ -->
                    <div class="form-group" style="display: flex; justify-content: space-between; align-items: center;">
                        <label for="stream-switch" style="margin-bottom: 0;">
                            启用流式传输
                            <p style="font-size: 12px; font-weight: normal; color: #999; margin-top: 5px;">
                                开启后，AI的回复会逐字显示，体验更流畅。
                            </p>
                        </label>
                        <label class="toggle-switch">
                            <input type="checkbox" id="stream-switch">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <!-- ▲▲▲ 新增结束 ▲▲▲ -->

                    <!-- ▼▼▼ 在这里新增 ▼▼▼ -->
                    <div class="form-group" style="display: flex; justify-content: space-between; align-items: center;">
                        <label for="hide-stream-switch" style="margin-bottom: 0;">
                            隐藏流式响应
                            <p style="font-size: 12px; font-weight: normal; color: #999; margin-top: 5px;">
                                开启后，流式回复将等待全部接收完毕后一次性显示，更像真实对话。
                            </p>
                        </label>
                        <label class="toggle-switch">
                            <input type="checkbox" id="hide-stream-switch">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <!-- ▲▲▲ 新增结束 ▲▲▲ -->

                    <button class="form-button" id="save-api-settings-btn">保存设置</button>
                    <hr style="margin:20px 0; opacity:.3">

                    <button class="form-button" id="export-data-btn">导出数据</button>

                    <!-- ① 普通按钮，和“导出”一个 class -->
                    <button class="form-button" id="import-btn">导入备份文件</button>

                    <!-- ② 真正的文件选择器，完全隐藏 -->
                    <input id="import-data-input" type="file" accept="application/json" hidden>
                </div>
            </div>
            <!-- ▼▼▼ 用下面这段代码，完整替换掉你原来的 chat-list-screen ▼▼▼ -->
            <div id="chat-list-screen" class="screen">

                <!-- 主头部 (只在消息列表显示) -->
                <div class="header" id="main-chat-list-header">
                    <span class="back-btn" onclick="showScreen('home-screen')">‹</span>
                    <span id="chat-list-title">消息</span>
                    <div class="header-actions">
                        <span class="action-btn" id="add-group-chat-btn" title="创建群聊"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M17.5 17.5C19.1569 17.5 20.5 16.1569 20.5 14.5C20.5 12.8431 19.1569 11.5 17.5 11.5C15.8431 11.5 14.5 12.8431 14.5 14.5C14.5 16.1569 15.8431 17.5 17.5 17.5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M21 21L19 19" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M8.5 11.5C10.1569 11.5 11.5 10.1569 11.5 8.5C11.5 6.84315 10.1569 5.5 8.5 5.5C6.84315 5.5 5.5 6.84315 5.5 8.5C5.5 10.1569 6.84315 11.5 8.5 11.5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M12.5 14.5H4.5C3.39543 14.5 2.5 15.3954 2.5 16.5V18.5H12.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></span>
                        <span class="action-btn" id="add-chat-btn">+</span>
                    </div>
                </div>

                <!-- 消息列表视图 -->
                <div id="messages-view" class="chat-list-view active">
                    <div id="chat-list">
                        <!-- JS会在这里生成聊天列表 -->
                    </div>
                </div>

                <!-- 动态界面视图 -->
                <div id="qzone-screen" class="chat-list-view">
                    <div class="qzone-header">
                        <span class="back-btn" id="qzone-back-btn">‹</span> <!-- 这个按钮现在只负责从动态返回 -->
                        <span>好友动态</span>
                    </div>
                    <div class="qzone-content">
                        <div class="qzone-profile-header">
                            <div id="qzone-banner-container" class="qzone-banner-container">
                                <img id="qzone-banner-img" src="https://files.catbox.moe/r5heyt.gif" alt="背景">
                                <input type="file" id="qzone-banner-input" accept="image/*" hidden>
                            </div>
                            <div class="qzone-user-info">
                                <div id="qzone-avatar-container" class="qzone-avatar-container">
                                    <img id="qzone-avatar-img" src="https://files.catbox.moe/q6z5fc.jpeg" alt="头像">
                                    <input type="file" id="qzone-avatar-input" accept="image/*" hidden>
                                </div>
                                <span id="qzone-nickname">{{user}}</span>
                            </div>
                        </div>
                        <div class="qzone-actions-bar">
                            <div class="action-item" id="create-shuoshuo-btn"><span>说说</span></div>
                            <div class="action-item" id="create-post-btn"><span>动态</span></div>
                            <div class="action-item" id="open-album-btn"><span>相册</span></div>
                        </div>
                        <div id="qzone-posts-list"></div>
                    </div>
                </div>

                <!-- 收藏界面视图 -->
                <div id="favorites-view" class="chat-list-view">
                    <div class="header">
                        <span class="back-btn" id="favorites-back-btn">‹</span>
                        <span>我的收藏</span>
                        <!-- 新增的编辑按钮 -->
                        <span class="action-btn" id="favorites-edit-btn">编辑</span>
                    </div>

                    <!-- 【新增】搜索栏容器 -->
                    <div class="search-bar-container">
                        <input type="search" id="favorites-search-input" placeholder="搜索收藏的标题、内容或作者...">
                        <button id="favorites-search-clear-btn" class="search-clear-btn" style="display: none;">×</button>
                    </div>

                    <div id="favorites-list" class="list-container">
                        <!-- 收藏内容将由JS动态生成在这里 -->
                    </div>

                    <!-- 新增：收藏页底部操作栏 -->
                    <div id="favorites-action-bar" style="display: none;">
                        <button id="favorites-delete-selected-btn" class="action-bar-btn">删除 (0)</button>
                    </div>

                </div>

                <!-- ▼▼▼ 【全新】回忆录界面视图 ▼▼▼ -->
                <div id="memories-view" class="chat-list-view">
                    <div class="header">
                        <span class="back-btn" id="memories-back-btn">‹</span>
                        <span>我们的回忆</span>
                        <span class="action-btn" id="add-countdown-btn">+</span>
                    </div>
                    <div id="memories-list" class="list-container" style="padding: 15px; display: flex; flex-direction: column; gap: 15px;">
                        <!-- 回忆卡片将由JS动态生成在这里 -->
                    </div>
                </div>
                <!-- ▲▲▲ 新增HTML结束 ▲▲▲ -->

                <!-- 底部导航栏 -->
                <div id="chat-list-bottom-nav">
                    <div class="nav-item active" data-view="messages-view">
                        <span>消息</span>
                    </div>
                    <div class="nav-item" data-view="qzone-screen">
                        <span>动态</span>
                    </div>
                    <!-- ▼▼▼ 在“动态”和“收藏”之间，加入这个新页签 ▼▼▼ -->
                    <div class="nav-item" data-view="memories-view">
                        <span>回忆</span>
                    </div>
                    <!-- ▲▲▲ 添加结束 ▲▲▲ -->
                    <div class="nav-item" data-view="favorites-view">
                        <span>收藏</span>
                    </div>
                </div>
            </div>
            <!-- ▲▲▲ 替换区域结束 ▲▲▲ -->

            <!-- ▼▼▼ 请将这段新的 HTML 粘贴到 id="chat-list-screen" 的 div 之后 ▼▼▼ -->
            <div id="album-screen" class="screen">
                <!-- 1. 页面头部，包含返回按钮和标题 -->
                <div class="header">
                    <span class="back-btn" id="album-back-btn">‹</span>
                    <span>我的相册</span>
                    <span class="action-btn" id="create-album-btn-page">+</span>
                </div>

                <!-- 2. 页面内容容器 -->
                <div class="list-container">
                    <div id="album-grid-page">
                        <!-- 相册列表将由 JS 动态生成在这里 -->
                    </div>
                </div>
            </div>
            <!-- ▲▲▲ 新的 HTML 粘贴结束 ▲▲▲ -->

            <!-- ▼▼▼ 请将这段新的 HTML 粘贴到 id="album-screen" 的 div 之后 ▼▼▼ -->
            <div id="album-photos-screen" class="screen">
                <!-- 1. 页面头部 -->
                <div class="header">
                    <span class="back-btn" id="album-photos-back-btn">‹</span>
                    <span id="album-photos-title">相册名称</span>
                    <span class="action-btn" id="album-upload-photo-btn">上传</span>
                </div>

                <!-- 2. 页面内容容器 -->
                <div class="list-container">
                    <div id="photos-grid-page">
                        <!-- 照片列表将由 JS 动态生成在这里 -->
                    </div>

                    <!-- ▼▼▼ 请将这段新的 HTML 粘贴到所有模态框的末尾 ▼▼▼ -->
                    <div id="photo-viewer-modal" class="modal">
                        <!-- 1. 关闭按钮 -->
                        <button id="photo-viewer-close-btn">×</button>

                        <!-- 2. 上一张照片按钮 -->
                        <button id="photo-viewer-prev-btn" class="nav-arrow">‹</button>

                        <!-- 3. 图片容器 -->
                        <div class="photo-viewer-content">
                            <img id="photo-viewer-image" src="" alt="全屏照片预览">
                        </div>

                        <!-- 4. 下一张照片按钮 -->
                        <button id="photo-viewer-next-btn" class="nav-arrow">›</button>
                    </div>
                    <!-- ▲▲▲ 新的 HTML 粘贴结束 ▲▲▲ -->

                </div>
            </div>
            <!-- ▲▲▲ 新的 HTML 粘贴结束 ▲▲▲ -->

            <!-- ▼▼▼ 粘贴到 #album-photos-screen 的 div 之后 ▼▼▼ -->
            <input type="file" id="album-photo-input" accept="image/*" multiple hidden>

            <!-- ▼▼▼ 请用这【一整块】全新的代码，完整替换掉您文件中旧的 #chat-interface-screen 及其所有内容 ▼▼▼ -->
            <div id="chat-interface-screen" class="screen">

                <!-- 【最终修正版】Header，已将状态栏和搜索功能正确整合 -->
                <div class="header">
                    <!-- 默认控件：包含标题、状态栏和常规按钮 -->
                    <div class="default-controls">
                        <span class="back-btn" id="back-to-list-btn">‹</span>

                        <!-- ▼▼▼ 【核心新增】标题和状态的容器 ▼▼▼ -->
                        <div id="chat-header-title-wrapper">
                            <span id="chat-header-title">聊天对象</span>
                            <div id="chat-header-status">
                                <span class="status-dot"></span>
                                <span class="status-text">在线</span>
                            </div>
                        </div>
                        <!-- ▲▲▲ 新增结束 ▲▲▲ -->

                        <div class="header-actions">
                            <span class="action-btn" id="listen-together-btn" title="一起听"><img src="img/Listen-Together.png" alt="一起听"></span>
                            <span class="action-btn" id="chat-settings-btn" title="聊天设置"><img src="img/Chat-Settings.png" alt="设置"></span>
                        </div>
                    </div>

                    <!-- 多选模式控件 (保持不变) -->
                    <div class="selection-controls">
                        <span id="selection-cancel-btn">取消</span>
                        <span id="selection-count"></span>
                        <div class="header-actions">
                            <span id="selection-favorite-btn" class="action-btn">收藏</span>
                            <span id="selection-share-btn" class="action-btn">分享</span>
                            <span id="selection-delete-btn" class="action-btn" style="color: #ff3b30;">删除</span>
                        </div>
                    </div>
                </div>

                <!-- 聊天消息区域 (保持不变) -->
                <div id="chat-messages">
                    <div id="typing-indicator">对方正在输入...</div>
                </div>

                <!-- 输入区域 (保持不变) -->
                <div id="chat-input-area">
                    <div id="reply-preview-bar">
                        <div class="reply-preview-content">
                            <div class="sender">回复 xxx:</div>
                            <div class="text">被引用的消息内容...</div>
                        </div>
                        <span id="cancel-reply-btn">×</span>
                    </div>
                    <div id="chat-input-actions-top">
                        <button id="open-sticker-panel-btn" class="chat-action-icon-btn action-button" title="表情面板">+</button>
                        <button id="send-photo-btn" class="chat-action-icon-btn action-button" title="发送照片"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg></button>
                        <button id="upload-image-btn" class="chat-action-icon-btn action-button" title="上传图片"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="color: var(--text-primary);"><path d="M21 3.5H3C2.44772 3.5 2 3.94772 2 4.5V19.5C2 20.0523 2.44772 20.5 3 20.5H21C21.5523 20.5 22 20.0523 22 19.5V4.5C22 3.94772 21.5523 3.5 21 3.5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M16.5 13.5C17.6046 13.5 18.5 12.6046 18.5 11.5C18.5 10.3954 17.6046 9.5 16.5 9.5C15.3954 9.5 14.5 10.3954 14.5 11.5C14.5 12.6046 15.3954 13.5 16.5 13.5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M22 14.5L18 10.5L10.3333 18.5M12.5 16L9 12.5L2 19.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></button>
                        <button id="transfer-btn" class="chat-action-icon-btn action-button" title="转账">￥</button>
                        <button id="voice-message-btn" class="chat-action-icon-btn action-button" title="发送语音"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><path d="M12 19v4"/><path d="M8 23h8"/></svg></button>
                        <!-- ▼▼▼ 将这行新代码粘贴到“发送语音”按钮的后面 ▼▼▼ -->
                        <button id="send-waimai-request-btn" class="chat-action-icon-btn action-button" title="发起外卖请求"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"/><line x1="3" y1="6" x2="21" y2="6"/><path d="M16 10a4 4 0 0 1-8 0"/></svg></button>
                        <!-- ▲▲▲ 新代码粘贴结束 ▲▲▲ -->
                        <!-- ▼▼▼ 【新增】视频通话按钮 ▼▼▼ -->
                        <button id="video-call-btn" class="chat-action-icon-btn action-button" title="视频通话"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="23 7 16 12 23 17 23 7"></polygon><rect x="1" y="5" width="15" height="14" rx="2" ry="2"></rect></svg></button>
                        <!-- ▲▲▲ 新增结束 ▲▲▲ -->
                        <!-- ▼▼▼群视频通话按钮 ▼▼▼ -->
                        <button id="group-video-call-btn" class="chat-action-icon-btn action-button" title="群视频通话"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg></button>
                        <!-- ▲▲▲ 全新添加结束 ▲▲▲ -->
                        <!-- ▼▼▼发起投票按钮▼▼▼ -->
                        <button id="send-poll-btn" class="chat-action-icon-btn action-button" title="发起投票"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 6h10"/><path d="M6 6h.01"/><path d="M8 12h10"/><path d="M6 12h.01"/><path d="M8 18h10"/><path d="M6 18h.01"/></svg></button>
                        <!-- ▲▲▲ 替换结束 ▲▲▲ -->
                        <!-- ▼▼▼ 在 id="chat-input-actions-top" 的末尾，【添加】这个新的按钮 ▼▼▼ -->
                        <button id="share-link-btn" class="chat-action-icon-btn action-button" title="分享链接"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.72"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.72-1.72"></path></svg></button>
                        <!-- ▲▲▲ 新增HTML结束 ▲▲▲ -->
                    </div>
                    <div id="chat-input-main-row">
                        <textarea id="chat-input" rows="1" placeholder="输入消息..."></textarea>
                        <div id="input-actions-wrapper">
                            <button id="wait-reply-btn" title="等待回复"><img src="img/Wait-Reply.png" alt="等待回复"></button>
                            <button id="send-btn" class="action-button">发送</button>
                        </div>
                    </div>
                </div>

                <!-- ▼▼▼ 在这里新增 ▼▼▼ -->
                <div id="chat-lock-overlay">
                    <div id="chat-lock-content"></div>
                </div>
                <!-- ▲▲▲ 新增结束 ▲▲▲ -->

                <!-- 表情面板 (保持不变) -->
                <div id="sticker-panel">
                    <div id="sticker-panel-header">
                        <span class="panel-btn" id="close-sticker-panel-btn">取消</span>
                        <span class="title">我的表情</span>
                        <div style="display: flex; gap: 10px;">
                            <span class="panel-btn" id="add-sticker-btn">添加</span>
                            <span class="panel-btn" id="upload-sticker-btn">上传</span>
                        </div>
                    </div>
                    <div id="sticker-grid"></div>
                </div>
                <input type="file" id="sticker-upload-input" accept="image/*" style="display: none;">
                <input type="file" id="image-upload-input" accept="image/*" style="display: none;">

                <!-- 音乐播放器 (保持不变) -->
                <div id="music-player-overlay">
                    <div class="music-player-window">

                        <!-- 1. 顶部操作栏 -->
                        <div class="music-player-top-actions">
                            <div class="top-left-cluster">
                                <button id="music-return-btn">‹</button>
                                <button id="music-exit-btn">×</button>
                            </div>
                            <span id="music-playlist-btn">☰</span>
                        </div>

                        <!-- 2. 歌曲信息 -->
                        <div id="music-time-counter">已经一起听了0.0小时</div>
                        <div id="music-player-song-title">请添加歌曲</div>
                        <div id="music-player-artist">...</div>

                        <!-- 3. 【全新】歌词显示区域 -->
                        <div id="music-lyrics-container">
                            <div id="music-lyrics-list">
                                <!-- 歌词将由JS动态生成在这里 -->
                                <div class="lyric-line">♪ 暂无歌词 ♪</div>
                            </div>
                        </div>

                        <!-- 4. 【全新】播放控制区的包裹容器 -->
                        <div class="music-player-controls-wrapper">
                            <!-- a. 新的iOS风格进度条 -->
                            <div class="music-progress-bar-container">
                                <div id="music-current-time" class="time-display">0:00</div>
                                <div class="progress-bar">
                                    <div id="music-progress-fill" class="progress-bar-fill"></div>
                                </div>
                                <div id="music-total-time" class="time-display">0:00</div>
                            </div>

                            <!-- b. 播放控制按钮 -->
                            <div class="music-controls">
                                <button id="music-prev-btn">◀</button>
                                <button id="music-play-pause-btn" class="play-pause-btn">▶</button>
                                <button id="music-next-btn">▶</button>
                                <button id="music-mode-btn">顺序</button>
                            </div>
                        </div>

                    </div>
                </div>

                <div id="music-playlist-panel">
                    <div class="playlist-header">
                        <span class="panel-btn" id="close-playlist-btn">返回</span>
                        <span>播放列表</span>
                        <div>
                            <span class="panel-btn" id="add-song-local-btn">本地</span>
                            <span class="panel-btn" id="add-song-url-btn">URL</span>
                        </div>
                    </div>
                    <div class="playlist-body" id="playlist-body"></div>
                </div>
                <input type="file" id="local-song-upload-input" accept="audio/*" multiple style="display: none;">
                <input type="file" id="lrc-upload-input" accept=".lrc" style="display: none;">
            </div>
            <!-- ▲▲▲ 替换结束 ▲▲▲ -->

            <!-- ▼▼▼ 用这整块代码替换你原来的 id="wallpaper-screen" ▼▼▼ -->
            <div id="wallpaper-screen" class="screen">
                <div class="header">
                    <span class="back-btn" onclick="showScreen('home-screen')">‹</span>
                    <!-- 【核心修改1】标题改为“外观设置”，更通用 -->
                    <span>外观设置</span>
                    <span style="width: 30px;"></span>
                </div>
                <div class="form-container">
                    <!-- 壁纸设置部分保持不变 -->
                    <div id="wallpaper-preview">点击下方上传</div>
                    <button class="form-button" onclick="document.getElementById('wallpaper-upload-input').click();">上传壁纸</button>
                    <input type="file" id="wallpaper-upload-input" accept="image/*">

                    <!-- ▼▼▼ 将【上面整块代码】，完整替换为下面这段【全新的代码】 ▼▼▼ -->
                    <div class="form-group" style="display: flex; justify-content: space-between; align-items: center;">
                        <label for="theme-toggle-switch" style="margin-bottom: 0;">夜间模式</label>
                        <label class="toggle-switch">
                            <input type="checkbox" id="theme-toggle-switch">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <!-- ▲▲▲ 替换结束 ▲▲▲ -->

                    <!-- 【核心修改2】新增图标设置区域 -->
                    <hr style="width: 80%; opacity: 0.3; margin: 30px 0;">
                    <div style="width:100%; text-align: left; margin-bottom: 15px;">
                        <label style="font-weight: 500; color: var(--text-secondary);">App 图标设置</label>
                    </div>
                    <div id="icon-settings-grid">
                        <!-- 图标设置项将由JS动态生成在这里 -->
                    </div>

                    <!-- 【核心修改3】按钮文字也改一下 -->
                    <button class="form-button" id="save-wallpaper-btn" style="margin-top: 30px;">保存所有外观设置</button>
                </div>
            </div>
            <!-- ▲▲▲ 替换结束 ▲▲▲ -->

            <!-- ▼▼▼ 【全新】分享链接功能 HTML ▼▼▼ -->
            <div id="browser-screen" class="screen">
                <div class="header">
                    <span class="back-btn" id="browser-back-btn">‹</span>
                    <span id="browser-title"></span>
                    <span style="width: 30px;"></span>
                </div>
                <div id="browser-content" class="list-container">
                    <!-- 文章内容将由JS动态生成在这里 -->
                </div>
            </div>
            <!-- ▲▲▲ 新HTML粘贴结束 ▲▲▲ -->

            <div id="font-settings-screen" class="screen">
                <div class="header">
                    <span class="back-btn" onclick="showScreen('home-screen')">‹</span>
                    <span>字体设置</span>
                    <span style="width: 30px;"></span>
                </div>
                <div class="form-container">
                    <div class="form-group">
                        <label for="font-url-input">字体文件URL (.ttf, .otf, .woff等)</label>
                        <input type="text" id="font-url-input" placeholder="https://..../font.ttf">
                    </div>

                    <div class="form-group">
                        <label>实时预览</label>
                        <div id="font-preview">
                            <p style="font-size: 20px; margin: 0 0 10px 0;">你好世界 Hello World</p>
                            <p style="margin: 0;">这是字体预览效果，12345。</p>
                        </div>
                    </div>

                    <button class="form-button" id="save-font-btn">保存并应用</button>
                    <button class="form-button form-button-secondary" id="reset-font-btn">恢复默认字体</button>
                </div>
            </div>

            <!-- ▼▼▼ 【全新】选择联系人以创建群聊的屏幕 ▼▼▼ -->
            <div id="contact-picker-screen" class="screen">
                <div class="header">
                    <span class="back-btn" id="cancel-contact-picker-btn">取消</span>
                    <span>选择联系人</span>
                    <span class="save-btn" id="confirm-contact-picker-btn">完成(0)</span>
                </div>
                <div class="list-container" id="contact-picker-list">
                    <!-- 联系人列表将由JS动态生成 -->
                </div>
            </div>
            <!-- ▲▲▲ 新HTML粘贴结束 ▲▲▲ -->

            <!-- ▼▼▼ 【全新】群成员管理屏幕 ▼▼▼ -->
            <div id="member-management-screen" class="screen">
                <div class="header">
                    <span class="back-btn" id="back-from-member-management">‹</span>
                    <span>群成员管理</span>
                    <span style="width: 30px;"></span>
                </div>
                <div class="list-container" id="member-management-list">
                    <!-- 现有成员列表会在这里动态生成 -->
                </div>
                <div id="member-management-actions">
                    <button id="add-existing-contact-btn">从好友列表添加</button>
                    <button id="create-new-member-btn">创建群内新成员</button>
                </div>
            </div>
            <!-- ▲▲▲ 新HTML粘贴结束 ▲▲▲ -->

            <!-- ▼▼▼ 【全新】来电请求模态框 ▼▼▼ -->
            <div id="incoming-call-modal" class="modal">
                <div class="incoming-call-content">
                    <img id="caller-avatar" class="caller-avatar" src="">
                    <div id="caller-name" class="caller-name"></div>
                    <div class="caller-text">邀请你视频通话</div>
                    <div class="incoming-call-actions">
                        <div class="action-button-wrapper">
                            <button id="decline-call-btn" class="call-action-btn decline"></button>
                            <span>拒绝</span>
                        </div>
                        <div class="action-button-wrapper">
                            <button id="accept-call-btn" class="call-action-btn accept"></button>
                            <span>接听</span>
                        </div>
                    </div>
                </div>
            </div>
            <!-- ▲▲▲ 新增结束 ▲▲▲ -->

            <!-- ▼▼▼ 请用这段【全新群聊兼容结构】的代码，完整替换你旧的 #video-call-screen ▼▼▼ -->
            <div id="video-call-screen" class="screen">
                <!-- 1. 顶部栏 (保持不变) -->
                <div class="video-call-top-bar">
                    <span id="call-timer">00:00</span>
                </div>

                <!-- 2. 【升级】参与者头像网格区域 -->
                <div class="video-call-avatar-area">
                    <div id="participant-avatars-grid">
                        <!-- JS会在这里动态生成头像 -->
                    </div>
                </div>

                <!-- 3. 对话框区域 (保持不变) -->
                <div id="video-call-main" class="video-call-main">
                    <!-- 对话内容会动态生成在这里 -->
                </div>

                <!-- 4. 【升级】底部控制栏，现在包含一个“加入”按钮 -->
                <div class="video-call-controls">
                    <button id="user-speak-btn" class="control-btn speak-btn"></button>
                    <button id="hang-up-btn" class="control-btn hangup-btn"></button>
                    <!-- 这个按钮默认隐藏，只在用户“旁观”时显示 -->
                    <button id="join-call-btn" class="control-btn join-btn" style="display: none;"></button>
                </div>
            </div>
            <!-- ▲▲▲ 替换结束 ▲▲▲ -->

            <!-- ▼▼▼ 【全新添加】正在呼叫界面 ▼▼▼ -->
            <div id="outgoing-call-screen" class="screen">
                <div class="outgoing-call-content">
                    <img id="outgoing-call-avatar" class="caller-avatar" src="">
                    <div id="outgoing-call-name" class="caller-name"></div>
                    <div class="caller-text">正在呼叫...</div>
                    <div class="outgoing-call-actions">
                        <button id="cancel-call-btn" class="call-action-btn decline"></button>
                        <span>取消</span>
                    </div>
                </div>
            </div>
            <!-- ▲▲▲ 添加结束 ▲▲▲ -->

            <!-- ▼▼▼ 【全新】通话记录页面 ▼▼▼ -->
            <div id="call-history-screen" class="screen">
                <div class="header">
                    <span class="back-btn" id="call-history-back-btn">‹</span>
                    <span id="call-history-title">通话记录</span>
                    <span style="width: 30px;"></span> <!-- 占位符，保持标题居中 -->
                </div>
                <div id="call-history-list" class="list-container" style="padding: 15px; display: flex; flex-direction: column; gap: 15px;">
                    <!-- 通话记录卡片将由JS动态生成在这里 -->
                </div>
            </div>
            <!-- ▲▲▲ 新HTML粘贴结束 ▲▲▲ -->

        </div>
    </div>

    <div id="chat-settings-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><span>聊天设置</span></div>
            <div class="modal-body">
                <div class="form-group" id="chat-name-group"><label for="chat-name-input">备注名 / 群名</label><input type="text" id="chat-name-input"></div>

                <!-- ▼▼▼ 请将这段新代码粘贴到“备注名”输入框的 form-group 之后 ▼▼▼ -->
                <div class="form-group" id="assign-group-section" style="display: none;"> <!-- 默认隐藏，只对单聊显示 -->
                    <label for="assign-group-select">好友分组</label>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <select id="assign-group-select" style="flex-grow: 1;">
                            <!-- 分组选项将由JS动态生成 -->
                        </select>
                        <button id="manage-groups-btn" class="form-button-secondary" style="margin-top: 0; padding: 12px;">管理分组</button>
                    </div>
                </div>
                <!-- ▲▲▲ 新代码粘贴结束 ▲▲▲ -->

                <div class="form-group" id="my-group-nickname-group"><label for="my-group-nickname-input">我的群昵称</label><input type="text" id="my-group-nickname-input"></div>
                <div class="form-group" id="group-avatar-group"><label>群头像</label>
                    <div class="avatar-upload"><img id="group-avatar-preview"><button onclick="document.getElementById('group-avatar-input').click()">上传群头像</button><input type="file" id="group-avatar-input" accept="image/*"></div>
                </div>
                <div class="form-group" id="world-book-link-group">
                    <label>关联世界书 (可多选)</label>
                    <div class="custom-multiselect">
                        <div class="select-box">
                            <span class="selected-options-text">-- 点击选择 --</span>
                            <span class="arrow-down">▼</span>
                        </div>
                        <div id="world-book-checkboxes-container" class="checkboxes-container">
                        </div>
                    </div>
                </div>
                <div class="form-group" id="ai-persona-group"><label for="ai-persona">对方人设 (AI Persona)</label><textarea id="ai-persona" rows="3"></textarea></div>
                <div class="form-group" id="ai-avatar-group"><label>对方头像</label>
                    <div class="avatar-upload"><img id="ai-avatar-preview"><button onclick="document.getElementById('ai-avatar-input').click()">上传对方头像</button><button id="manage-ai-avatar-library-btn">管理头像库</button>
                        <input type="file" id="ai-avatar-input" accept="image/*">
                    </div>
                </div>
                <div class="form-group" id="my-persona-group"><label for="my-persona">我的人设 (My Persona)</label><textarea id="my-persona" rows="3"></textarea></div>
                <div class="form-group" id="my-avatar-group"><label>我的头像</label>
                    <div class="avatar-upload"><img id="my-avatar-preview"><button onclick="document.getElementById('my-avatar-input').click()">上传我的头像</button><button id="open-persona-library-btn">预设</button><input type="file" id="my-avatar-input" accept="image/*"></div>
                </div>
                <div class="form-group" id="group-members-group"><label>群成员人设</label>
                    <div id="group-members-settings"></div>

                    <!-- 【新增】管理成员按钮 -->
                    <button id="manage-members-btn" class="form-button form-button-secondary" style="margin-top: 15px;">管理群成员</button>
                </div>
                <div class="form-group"><label for="max-memory">上下文记忆条数</label><input type="number" id="max-memory" value="10"></div>
                <div class="form-group"><label>聊天气泡主题 <button id="reset-theme-btn" type="button">重置</button></label>
                    <div class="theme-selector"><label><input type="radio" name="theme-select" value="default" id="theme-default"> 默认</label><label><input type="radio" name="theme-select" value="pink_blue"> 粉蓝</label><label><input type="radio" name="theme-select" value="blue_white"> 蓝白</label><label><input type="radio" name="theme-select" value="purple_yellow"> 紫黄</label><label><input type="radio" name="theme-select" value="black_white"> 黑白</label><label><input type="radio" name="theme-select" value="yellow_white"> 黄白</label><label><input type="radio" name="theme-select" value="red_black"> 红黑</label><label><input type="radio" name="theme-select" value="blue_yellow"> 蓝黄</label><label><input type="radio" name="theme-select" value="pink_yellow"> 粉黄</label><label><input type="radio" name="theme-select" value="pink_purple"> 粉紫</label><label><input type="radio" name="theme-select" value="gray_white"> 灰白</label><label><input type="radio" name="theme-select" value="blue_green"> 蓝绿</label><label><input type="radio" name="theme-select" value="pink_white"> 粉白</label><label><input type="radio" name="theme-select" value="pink_black"> 粉黑</label><label><input type="radio" name="theme-select" value="pink_green"> 粉绿</label><label><input type="radio" name="theme-select" value="green_black"> 绿黑</label></div>
                </div>

                <!-- ▼▼▼ 请将这段新代码粘贴到“聊天气泡主题”的 form-group 之后 ▼▼▼ -->
                <div class="form-group">
                    <label for="font-size-slider">聊天字体大小 <span id="font-size-value">13px</span></label>
                    <input type="range" id="font-size-slider" min="12" max="20" step="1" value="13" style="width: 100%; margin-top: 8px;">
                </div>
                <!-- ▲▲▲ 新代码粘贴结束 ▲▲▲ -->

                <!-- ▼▼▼ 请将这段新代码粘贴到“聊天字体大小”的 form-group 之后 ▼▼▼ -->
                <div class="form-group">
                    <label for="custom-css-input">
                        自定义气泡样式 (CSS)
                        <button id="reset-custom-css-btn" type="button" style="background: none; border: 1px solid #ccc; color: #555; font-size: 12px; padding: 2px 8px; border-radius: 5px; cursor: pointer; margin-left: 10px;">重置</button>
                    </label>
                    <textarea id="custom-css-input" rows="5" style="width: 100%; margin-top: 8px; font-family: monospace; font-size: 12px; resize: vertical;" placeholder="/* 示例：为“我”的气泡添加渐变背景和阴影 */
.message-bubble.user .content {
  background: linear-gradient(135deg, #a1c4fd, #c2e9fb);
  box-shadow: 0 4px 10px rgba(0,0,0,0.1);
  border-radius: 15px 4px 15px 15px;
}"></textarea>
                </div>
                <!-- ▲▲▲ 新代码粘贴结束 ▲▲▲ -->

                <!-- ▼▼▼ 请将这段新代码粘贴到自定义CSS输入框的 form-group 之后 ▼▼▼ -->
                <div class="form-group">
                    <label>实时预览</label>
                    <div id="settings-preview-area">
                        <!-- JS会在这里生成预览内容 -->
                    </div>
                </div>
                <!-- ▲▲▲ 新代码粘贴结束 ▲▲▲ -->

                <div class="form-group">
                    <label>聊天背景</label>
                    <div class="bg-upload-container">
                        <button type="button" class="form-button-secondary" style="width: auto; padding: 8px 12px; margin-top: 0;" onclick="document.getElementById('bg-input').click()">上传背景图</button>
                        <button type="button" id="remove-bg-btn">移除背景</button>
                    </div>
                    <img id="bg-preview" class="bg-preview-img">
                    <input type="file" id="bg-input" accept="image/*" style="display: none;">
                </div>
                <hr style="margin: 25px 0; border: none; border-top: 1px solid #eee;">
                <button class="form-button form-button-secondary" id="block-chat-btn" style="background-color: #ff3b30; color: white; border-color: #ff3b30;">拉黑对方</button>
                <button class="form-button form-button-secondary" id="clear-chat-btn">清空聊天记录</button>
            </div>
            <div class="modal-footer"><button class="cancel" id="cancel-chat-settings-btn">取消</button><button class="save" id="save-chat-settings-btn">保存</button></div>
        </div>
    </div>

    <div id="persona-library-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><span>我的人设库</span><button id="add-persona-preset-btn" class="action-button">添加</button></div>
            <div class="modal-body">
                <div id="persona-library-grid"></div>
            </div>
            <div class="modal-footer"><button class="cancel" id="close-persona-library-btn">关闭</button></div>
        </div>
    </div>

    <div id="persona-editor-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><span id="persona-editor-title">添加人设预设</span></div>
            <div class="modal-body">
                <div class="form-group"><label>预设头像</label>
                    <div class="avatar-upload"><img id="preset-avatar-preview"><button onclick="document.getElementById('preset-avatar-input').click()">上传头像</button><input type="file" id="preset-avatar-input" accept="image/*"></div>
                </div>
                <div class="form-group"><label for="preset-persona-input">预设人设</label><textarea id="preset-persona-input" rows="4" placeholder="在此输入这个人设的详细设定..."></textarea></div>
            </div>
            <div class="modal-footer"><button class="cancel" id="cancel-persona-editor-btn">取消</button><button class="save" id="save-persona-preset-btn">保存</button></div>
        </div>
    </div>

    <div id="member-settings-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><span>编辑群成员</span></div>
            <div class="modal-body">
                <div class="form-group"><label for="member-name-input">名字</label><input type="text" id="member-name-input"></div>
                <div class="form-group"><label for="member-persona-input">人设</label><textarea id="member-persona-input" rows="4"></textarea></div>
                <div class="form-group"><label>头像</label>
                    <div class="avatar-upload"><img id="member-avatar-preview"><button onclick="document.getElementById('member-avatar-input').click()">上传头像</button><input type="file" id="member-avatar-input" accept="image/*"></div>
                </div>
            </div>
            <div class="modal-footer"><button class="cancel" id="cancel-member-settings-btn">取消</button><button class="save" id="save-member-settings-btn">保存</button></div>
        </div>
    </div>

    <div id="custom-modal-overlay">
        <div id="custom-modal">
            <div class="custom-modal-header" id="custom-modal-title"></div>
            <div class="custom-modal-body" id="custom-modal-body"></div>
            <div class="custom-modal-footer">
                <button id="custom-modal-cancel">取消</button>
                <button id="custom-modal-confirm" class="confirm-btn">确定</button>
            </div>
        </div>
    </div>

    <div id="preset-actions-modal" class="modal">
        <div id="custom-modal" style="width: 250px;">
            <div class="custom-modal-footer">
                <button id="preset-action-edit">编辑预设</button>
                <button id="preset-action-delete" class="btn-danger">删除预设</button>
                <button id="preset-action-cancel" style="margin-top: 8px; border-radius: 8px; background-color: #f0f0f0;">取消</button>
            </div>
        </div>
    </div>

    <div id="transfer-modal">
        <div class="transfer-content">
            <div class="transfer-header">给Ta一个惊喜！</div>
            <div class="transfer-input-group">
                <label for="transfer-amount">转账金额</label>
                <input type="number" id="transfer-amount" placeholder="0.00" min="0" max="9999" step="0.01">
            </div>
            <div class="transfer-input-group">
                <label for="transfer-note">备注 (可选)</label>
                <input type="text" id="transfer-note" placeholder="留下你的小心思~" maxlength="20">
            </div>
            <div class="transfer-actions">
                <button id="transfer-cancel-btn">取消</button>
                <button id="transfer-confirm-btn">确认转账</button>
            </div>
        </div>
    </div>

    <div id="battery-alert-modal">
        <div class="battery-alert-content">
            <img id="battery-alert-image" src="">
            <p id="battery-alert-text"></p>
        </div>
    </div>

    <audio id="audio-player" style="display:none;"></audio>

    <!-- ▼▼▼ 用下面这段【完整】的模态框代码，替换掉你现有的 id="create-post-modal" 的整个 div ▼▼▼ -->
    <div id="create-post-modal" class="modal">
        <div class="modal-content" style="height: auto; max-height: 90%;">
            <div class="modal-header">
                <span>发布动态</span>
            </div>
            <div class="modal-body">
                <!-- 公开文字输入区 -->
                <div class="form-group">
                    <textarea id="post-public-text" rows="3" placeholder="分享新鲜事...（非必填的公开文字）"></textarea>
                </div>

                <!-- === 模式切换开关 (新增) === -->
                <div class="post-mode-switcher">
                    <button id="switch-to-image-mode" class="mode-btn active">上传图片</button>
                    <button id="switch-to-text-image-mode" class="mode-btn">使用文字图</button>
                </div>

                <!-- ▼▼▼ 【修正后】的可见范围设置 ▼▼▼ -->
                <div class="form-group">
                    <label>可见范围</label>
                    <div id="post-visibility-options" style="display: flex; gap: 15px; margin-bottom: 10px;">
                        <label><input type="radio" name="visibility" value="public" checked> 公开</label>

                        <label><input type="radio" name="visibility" value="include"> 指定分组可见</label>
                    </div>
                    <div id="post-visibility-groups" style="display: none; max-height: 120px; overflow-y: auto; background: #f9f9f9; padding: 10px; border-radius: 8px;">
                        <!-- 分组多选框将由JS动态生成 -->
                    </div>
                </div>
                <!-- ▲▲▲ 修正结束 ▲▲▲ -->

                <!-- === 图片模式区域 === -->
                <div id="image-mode-content" class="post-mode-content active">
                    <div class="form-group">
                        <div id="post-image-preview-container" class="post-image-preview-container">
                            <img id="post-image-preview" src="" alt="图片预览">
                            <button id="post-remove-image-btn">×</button>
                        </div>
                        <div class="post-image-upload-options">
                            <button id="post-upload-local-btn" class="form-button-secondary">本地上传</button>
                            <button id="post-use-url-btn" class="form-button-secondary">网络URL</button>
                            <input type="file" id="post-local-image-input" accept="image/*" hidden>
                        </div>
                    </div>
                    <div id="post-image-desc-group" class="form-group" style="display: none;">
                        <label>图片描述 (必填，给AI看)</label>
                        <input type="text" id="post-image-description" placeholder="简单描述图片内容，帮助AI理解">
                    </div>
                </div>

                <!-- === 文字图模式区域 (新增) === -->
                <div id="text-image-mode-content" class="post-mode-content">
                    <div class="form-group">
                        <label>文字图 (给AI理解用的描述，点击图片后可见)</label>
                        <textarea id="post-hidden-text" rows="4" placeholder="在这里写下图片描述..."></textarea>
                    </div>
                </div>

            </div>
            <div class="modal-footer">
                <button class="cancel" id="cancel-create-post-btn">取消</button>
                <button class="save" id="confirm-create-post-btn">发布</button>
            </div>
        </div>
    </div>
    <!-- ▲▲▲ 替换结束 ▲▲▲ -->

    <!-- ▼▼▼ 请将这个新的模态框HTML粘贴到所有其他模态框之后 ▼▼▼ -->
    <div id="group-management-modal" class="modal">
        <div class="modal-content" style="height: 60%;">
            <div class="modal-header">
                <span>管理好友分组</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>新建分组</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="new-group-name-input" placeholder="输入分组名..." style="flex-grow: 1;">
                        <button id="add-new-group-btn" class="form-button" style="width: auto; margin-top: 0; padding: 0 15px;">添加</button>
                    </div>
                </div>
                <hr style="opacity: 0.2;">
                <div id="existing-groups-list" style="display: flex; flex-direction: column; gap: 10px;">
                    <!-- 分组列表将由JS动态生成 -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="save" id="close-group-manager-btn" style="width: 100%;">完成</button>
            </div>
        </div>
    </div>
    <!-- ▲▲▲ 新代码粘贴结束 ▲▲▲ -->

    <!-- ▼▼▼ 请将这段新HTML粘贴到所有模态框的末尾 ▼▼▼ -->
    <div id="message-actions-modal" class="modal">
        <div id="custom-modal" style="width: 250px;">
            <div class="custom-modal-footer">
                <!-- 新的操作按钮 -->
                <button id="edit-message-btn">编辑消息</button>
                <button id="copy-message-btn">复制文本</button>
                <button id="recall-message-btn">撤回</button>
                <button id="quote-message-btn">引用</button>
                <button id="select-message-btn">进入多选</button>
                <!-- 取消按钮 -->
                <button id="cancel-message-action-btn" style="margin-top: 8px; border-radius: 8px; background-color: #f0f0f0;">取消</button>
            </div>
        </div>
    </div>
    <!-- ▲▲▲ 新HTML粘贴结束 ▲▲▲ -->

    <!-- ▼▼▼ 请将这段新HTML粘贴到所有模态框的末尾 ▼▼▼ -->
    <div id="post-actions-modal" class="modal">
        <div id="custom-modal" style="width: 250px;">
            <div class="custom-modal-footer">
                <button id="edit-post-btn">编辑动态</button>
                <button id="copy-post-btn">复制内容</button>
                <button id="cancel-post-action-btn">取消</button>
            </div>
        </div>
    </div>
    <!-- ▲▲▲ 新HTML粘贴结束 ▲▲▲ -->

    <!-- ▼▼▼ 【全新】可视化消息编辑器模态框 ▼▼▼ -->
    <div id="message-editor-modal" class="modal">
        <div class="modal-content" style="height: 75%;">
            <div class="modal-header">
                <span>编辑与拆分消息</span>
            </div>
            <div class="modal-body" id="message-editor-body">
                <!-- 编辑器容器，JS会在这里动态生成文本框 -->
                <div id="message-editor-container"></div>
                <!-- 添加新消息的按钮 -->
                <button id="add-message-editor-block-btn" class="form-button form-button-secondary" style="margin-top: 15px;">
                    [+] 添加下一条消息
                </button>
            </div>
            <div class="modal-footer">
                <button class="cancel" id="cancel-advanced-editor-btn">取消</button>
                <button class="save" id="save-advanced-editor-btn">保存更改</button>
            </div>
        </div>
    </div>
    <!-- ▲▲▲ 新HTML粘贴结束 ▲▲▲ -->

    <!-- ▼▼▼ 【全新】外卖请求模态框 ▼▼▼ -->
    <div id="waimai-request-modal" class="modal">
        <div class="modal-content" style="width: 290px;">
            <div class="modal-header">
                <span>发起外卖代付</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="waimai-product-info">商品信息</label>
                    <input type="text" id="waimai-product-info" placeholder="例如：一杯杨枝甘露">
                </div>
                <div class="form-group">
                    <label for="waimai-amount">代付金额 (元)</label>
                    <input type="number" id="waimai-amount" placeholder="例如：21" min="0" step="0.01">
                </div>
            </div>
            <div class="modal-footer">
                <button class="cancel" id="waimai-cancel-btn">取消</button>
                <button class="save" id="waimai-confirm-btn">发起请求</button>
            </div>
        </div>
    </div>

    <!-- ▼▼▼ 【全新】新建约定/倒计时模态框 ▼▼▼ -->
    <div id="create-countdown-modal" class="modal">
        <div class="modal-content" style="height: auto;">
            <div class="modal-header">
                <span>新建约定</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="countdown-title-input">约定标题</label>
                    <input type="text" id="countdown-title-input" placeholder="例如：我的生日">
                </div>
                <div class="form-group">
                    <label for="countdown-date-input">约定日期与时间</label>
                    <input type="datetime-local" id="countdown-date-input">
                </div>
            </div>
            <div class="modal-footer">
                <button class="cancel" id="cancel-create-countdown-btn">取消</button>
                <button class="save" id="confirm-create-countdown-btn">保存约定</button>
            </div>
        </div>
    </div>
    <!-- ▲▲▲ 新HTML粘贴结束 ▲▲▲ -->

    <!-- ▼▼▼ 【全新】发红包模态框 ▼▼▼ -->
    <div id="red-packet-modal" class="modal">
        <div class="modal-content" style="width: 300px; height: auto;">
            <div class="modal-header">
                <span>发红包</span>
            </div>
            <div class="modal-body" style="padding: 0;">
                <!-- 1. 页签切换 -->
                <div class="frame-tabs">
                    <div id="rp-tab-group" class="frame-tab active">拼手气红包</div>
                    <div id="rp-tab-direct" class="frame-tab">专属红包</div>
                </div>

                <!-- 2. 拼手气红包内容区 -->
                <div id="rp-content-group" class="frame-content" style="padding: 20px 15px;">
                    <div class="form-group">
                        <label>总金额 (元)</label>
                        <input type="number" id="rp-group-amount" placeholder="0.00">
                    </div>
                    <div class="form-group">
                        <label>红包个数</label>
                        <input type="number" id="rp-group-count" placeholder="填写红包个数">
                    </div>
                    <div class="form-group">
                        <label>祝福语</label>
                        <input type="text" id="rp-group-greeting" placeholder="恭喜发财，大吉大利！">
                    </div>
                    <p id="rp-group-total" style="text-align: center; font-size: 24px; font-weight: bold; margin: 10px 0;">¥ 0.00</p>
                    <button id="send-group-packet-btn" class="form-button">塞钱进红包</button>
                </div>

                <!-- 3. 专属红包内容区 -->
                <div id="rp-content-direct" class="frame-content" style="display: none; padding: 20px 15px;">
                    <div class="form-group">
                        <label>发送给</label>
                        <select id="rp-direct-receiver"></select>
                    </div>
                    <div class="form-group">
                        <label>金额 (元)</label>
                        <input type="number" id="rp-direct-amount" placeholder="0.00">
                    </div>
                    <div class="form-group">
                        <label>祝福语</label>
                        <input type="text" id="rp-direct-greeting" placeholder="恭喜发财，大吉大利！">
                    </div>
                    <p id="rp-direct-total" style="text-align: center; font-size: 24px; font-weight: bold; margin: 10px 0;">¥ 0.00</p>
                    <button id="send-direct-packet-btn" class="form-button">塞钱进红包</button>
                </div>
            </div>
            <div class="modal-footer" style="justify-content: center;">
                <button class="cancel" id="cancel-red-packet-btn" style="width: 100%;">取消</button>
            </div>
        </div>
    </div>
    <!-- ▲▲▲ 新HTML粘贴结束 ▲▲▲ -->

    <!-- ▼▼▼ 【全新】红包详情模态框 ▼▼▼ -->
    <div id="red-packet-details-modal" class="modal">
        <div class="modal-content" style="width: 280px; height: auto; background-color: #f7f7f7;">
            <div class="modal-header" style="background-color: #F96259; color: white; border-bottom: none; padding-bottom: 5px;">
                <div style="text-align: center; width: 100%;">
                    <div id="rp-details-sender" style="font-size: 16px;"></div>
                    <div style="font-size: 13px; opacity: 0.8;">的红包</div>
                </div>
            </div>
            <div class="modal-body" style="padding: 15px;">
                <p id="rp-details-greeting" style="text-align: center; font-size: 20px; color: #333; margin: 0 0 20px 0;"></p>
                <div id="rp-details-my-amount" style="text-align: center; display: none; margin-bottom: 20px;">
                    <span style="font-size: 40px; font-weight: bold; color: #E44D44;">0.00</span>
                    <span style="font-size: 18px; color: #E44D44;">元</span>
                </div>
                <div id="rp-details-summary" style="font-size: 13px; color: #8a8a8a; border-top: 1px solid #e0e0e0; padding-top: 10px;"></div>
                <div id="rp-details-list" style="max-height: 150px; overflow-y: auto; margin-top: 10px;">
                    <!-- 领取详情将由JS动态生成在这里 -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="save" id="close-rp-details-btn" style="width: 100%;">关闭</button>
            </div>
        </div>
    </div>
    <!-- ▲▲▲ 新HTML粘贴结束 ▲▲▲ -->
    <!-- ▼▼▼ 【全新】创建投票模态框 ▼▼▼ -->
    <div id="create-poll-modal" class="modal">
        <div class="modal-content" style="width: 300px; height: auto;">
            <div class="modal-header">
                <span>发起投票</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="poll-question-input">投票问题</label>
                    <textarea id="poll-question-input" rows="2" placeholder="例如：今晚我们看什么电影？"></textarea>
                </div>
                <div class="form-group">
                    <label>投票选项 (至少2项)</label>
                    <div id="poll-options-container" style="display: flex; flex-direction: column; gap: 8px;">
                        <!-- 投票选项将由JS动态生成在这里 -->
                    </div>
                    <button id="add-poll-option-btn" class="form-button form-button-secondary" style="margin-top: 12px;">+ 添加选项</button>
                </div>
            </div>
            <div class="modal-footer">
                <button class="cancel" id="cancel-create-poll-btn">取消</button>
                <button class="save" id="confirm-create-poll-btn">发起投票</button>
            </div>
        </div>
    </div>
    <!-- ▲▲▲ 新HTML粘贴结束 ▲▲▲ -->

    <!-- ▼▼▼ 【全新】AI头像库管理模态框 ▼▼▼ -->
    <div id="ai-avatar-library-modal" class="modal">
        <div class="modal-content" style="height: 70%;">
            <div class="modal-header">
                <span id="ai-avatar-library-title">对方的头像库</span>
                <button id="add-ai-avatar-btn" class="action-button">添加</button>
            </div>
            <div class="modal-body" style="padding: 15px;">
                <div id="ai-avatar-library-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 15px;">
                    <!-- 头像库内容将由JS动态生成 -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="save" id="close-ai-avatar-library-btn" style="width: 100%;">关闭</button>
            </div>
        </div>
    </div>

    <!-- ▲▲▲ 新HTML粘贴结束 ▲▲▲ -->

    <!-- ▼▼▼ 【全新】用户分享链接模态框 ▼▼▼ -->
    <div id="share-link-modal" class="modal">
        <div class="modal-content" style="width: 300px; height: auto;">
            <div class="modal-header">
                <span>分享链接</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="link-title-input">标题</label>
                    <input type="text" id="link-title-input" placeholder="输入文章或链接的标题">
                </div>
                <div class="form-group">
                    <label for="link-description-input">摘要 (可选)</label>
                    <textarea id="link-description-input" rows="2" placeholder="简单描述一下链接内容"></textarea>
                </div>
                <div class="form-group">
                    <label for="link-source-input">来源名称 (可选)</label>
                    <input type="text" id="link-source-input" placeholder="例如：知乎日报、B站">
                </div>
                <div class="form-group">
                    <label for="link-content-input">完整内容 (可选，用于浏览器内显示)</label>
                    <textarea id="link-content-input" rows="4" placeholder="粘贴或输入完整的文章内容"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="cancel" id="cancel-share-link-btn">取消</button>
                <button class="save" id="confirm-share-link-btn">分享</button>
            </div>
        </div>
    </div>
    <!-- ▲▲▲ 新HTML粘贴结束 ▲▲▲ -->

    <!-- ▼▼▼ 【全新】精致版转账操作弹窗 ▼▼▼ -->
    <div id="transfer-actions-modal" class="modal">
        <div class="transfer-actions-content">
            <div class="transfer-actions-header">请选择操作</div>
            <div class="transfer-actions-body">
                <p>你收到了来自 <strong id="transfer-sender-name"></strong> 的一笔转账。</p>
            </div>
            <div class="transfer-actions-footer">
                <button id="transfer-action-decline" class="action-btn decline">残忍拒绝</button>
                <button id="transfer-action-accept" class="action-btn accept">开心收下</button>
            </div>
            <button id="transfer-action-cancel" class="cancel-btn">×</button>
        </div>
    </div>
    <!-- ▲▲▲ 新HTML粘贴结束 ▲▲▲ -->

    <!-- ▼▼▼ 【全新】通话记录详情模态框 ▼▼▼ -->
    <div id="call-transcript-modal" class="modal">
        <div class="modal-content" style="height: 70%;">
            <div class="modal-header">
                <span id="transcript-modal-title">通话详情</span>
            </div>
            <div class="modal-body" id="transcript-modal-body" style="background-color: #f0f2f5;">
                <!-- 通话文字记录将由JS动态生成在这里 -->
            </div>
            <div class="modal-footer">
                <button class="cancel" id="delete-transcript-btn" style="background-color: #ff3b30; color: white; border-color: #ff3b30;">删除记录</button>
                <button class="save" id="close-transcript-modal-btn" style="width: 100%;">关闭</button>
            </div>
        </div>
    </div>
    <!-- ▲▲▲ 新HTML粘贴结束 ▲▲▲ -->

    <!-- ▼▼▼ 【全新】分享目标选择器模态框 ▼▼▼ -->
    <div id="share-target-modal" class="modal">
        <div class="modal-content" style="height: 70%;">
            <div class="modal-header">
                <span>分享到...</span>
            </div>
            <div class="modal-body" id="share-target-list" style="padding: 0;">
                <!-- 聊天列表将由JS动态生成在这里 -->
            </div>
            <div class="modal-footer">
                <button class="cancel" id="cancel-share-target-btn">取消</button>
                <button class="save" id="confirm-share-target-btn">确认分享</button>
            </div>
        </div>
    </div>

    <!-- ▼▼▼ 【全新】分享记录查看器模态框 ▼▼▼ -->
    <div id="shared-history-viewer-modal" class="modal">
        <div class="modal-content" style="height: 80%;">
            <div class="modal-header">
                <span id="shared-history-viewer-title">聊天记录</span>
            </div>
            <div class="modal-body" id="shared-history-viewer-content" style="background-color: #f0f2f5;">
                <!-- 分享的聊天记录气泡将由JS动态生成在这里 -->
            </div>
            <div class="modal-footer">
                <button class="save" id="close-shared-history-viewer-btn" style="width:100%;">关闭</button>
            </div>
        </div>
    </div>

    <!-- ▼▼▼ 【全新】世界书分类管理模态框 ▼▼▼ -->
    <div id="world-book-category-manager-modal" class="modal">
        <div class="modal-content" style="height: 60%;">
            <div class="modal-header">
                <span>管理世界书分类</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>新建分类</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="new-category-name-input" placeholder="输入分类名..." style="flex-grow: 1;">
                        <button id="add-new-category-btn" class="form-button" style="width: auto; margin-top: 0; padding: 0 15px;">添加</button>
                    </div>
                </div>
                <hr style="opacity: 0.2;">
                <div id="existing-categories-list" style="display: flex; flex-direction: column; gap: 10px;">
                    <!-- 分类列表将由JS动态生成 -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="save" id="close-category-manager-btn" style="width: 100%;">完成</button>
            </div>
        </div>
    </div>
    <!-- ▲▲▲ 新HTML粘贴结束 ▲▲▲ -->

    <script src="script.js"></script>
</body>

</html>